{
  "steps": [
    {
      "name": "gcr.io/cloud-builders/docker",
      "args": [
        "build",
        "-t",
        "${_LOCATION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/prediction-api:latest",
        "./prediction-api"
      ],
      "id": "build-prediction-api"
    },
    {
      "name": "gcr.io/cloud-builders/docker",
      "args": [
        "build",
        "-t",
        "${_LOCATION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/prediction-ui:latest",
        "./prediction-ui"
      ],
      "id": "build-prediction-ui"
    },
    {
      "name": "gcr.io/cloud-builders/docker",
      "args": [
        "push",
        "${_LOCATION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/prediction-api:latest"
      ],
      "id": "push-prediction-api",
      "waitFor": ["build-prediction-api"]
    },
    {
      "name": "gcr.io/cloud-builders/docker",
      "args": [
        "push",
        "${_LOCATION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/prediction-ui:latest"
      ],
      "id": "push-prediction-ui",
      "waitFor": ["build-prediction-ui"]
    },
    {
      "name": "gcr.io/cloud-builders/gcloud",
      "args": [
        "run",
        "deploy",
        "tsunami-prediction-api",
        "--image=${_LOCATION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/prediction-api:latest",
        "--region=${_REGION}",
        "--platform=managed",
        "--allow-unauthenticated",
        "--memory=2Gi",
        "--set-env-vars=MODEL_BUCKET=${_MODEL_BUCKET},PROJECT_ID=$PROJECT_ID,MODEL_FILE=${_MODEL_FILE}"
      ],
      "id": "deploy-prediction-api",
      "waitFor": ["push-prediction-api"]
    },
    {
      "name": "gcr.io/cloud-builders/gcloud",
      "entrypoint": "bash",
      "args": [
        "-c",
        "gcloud run services describe tsunami-prediction-api --region=${_REGION} --format='value(status.url)' > /workspace/api_url.txt"
      ],
      "waitFor": ["deploy-prediction-api"],
      "id": "get-api-url"
    },
    {
      "name": "gcr.io/cloud-builders/gcloud",
      "entrypoint": "bash",
      "args": [
        "-c",
        "echo \"API URL: $(cat /workspace/api_url.txt)\""
      ],
      "waitFor": ["get-api-url"],
      "id": "display-api-url"
    },
    {
      "name": "gcr.io/cloud-builders/gcloud",
      "entrypoint": "bash",
      "args": [
        "-c",
        "gcloud run deploy tsunami-prediction-ui --image=${_LOCATION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/prediction-ui:latest --region=${_REGION} --platform=managed --allow-unauthenticated --set-env-vars=PREDICTOR_API_URL=$(cat /workspace/api_url.txt)"
      ],
      "waitFor": ["get-api-url"],
      "id": "deploy-prediction-ui"
    }
  ],
  "options": {
    "logging": "CLOUD_LOGGING_ONLY"
  }
}
